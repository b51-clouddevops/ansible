- name: Copy MySQL repo file 
  ansible.builtin.copy:
    src: mysql.repo  
    dest: /etc/yum.repos.d/mysql.repo 

- name: Installing MySQL
  ansible.builtin.yum:
    name: 
      - mysql-community-server
      - MySQL-python
    state: installed 

- name: Starting MySQL 
  ansible.builtin.systemd:
    name: mysqld 
    state: started
    enabled: yes

# Whenever this is a failure, I'd like to reset the password
- name: Get MySQL version with non-default credentials
  community.mysql.mysql_info:
    login_user: root 
    login_password: RoboShop@1
  ignore_errors: yes 
  register: stat

- name: Password Reset Block 
  when: stat.failed 
  block: 
    - name: Fetch MySQL Default Password
      ansible.builtin.shell: grep 'temporary password' /var/log/mysqld.log | awk '{print $NF}'
      register: DEFAULT_ROOT_PASSWORD   

    - name: Copy MySQL Password Reset File 
      ansible.builtin.copy:
        src: root_password.sql
        dest: /tmp/root_password.sql

    - name: Reset MySQL Default Password
      ansible.builtin.shell:  mysql  --connect-expired-password  -uroot -p"{{DEFAULT_ROOT_PASSWORD.stdout}}"  < /tmp/root_password.sql
      register: DEFAULT_ROOT_PASSWORD
 
- name: Checking Password validate Plugin 
  ansible.builtin.shell: echo show plugins; | mysql -uroot -pRoboShop@1  | grep validate_password
  register: PLUGIN_INFO  
  ignore_errors: yes 

- name: Uninstall password validate plugin 
  when: PLUGIN_INFO.rc == 0
  ansible.builtin.copy:
    src: password_validate.mysql  
    dest: /tmp/password_validate.repo 

# 1. Next, We need to change the default root password in order to start using the database service. Use password as `RoboShop@1` . Rest of the options you can choose `No`

# ```bash
# # mysql_secure_installation
# ```

# 1. You can check whether the new password is working or not using the following command in MySQL

# First let's connect to MySQL

# ```bash
# # mysql -uroot -pRoboShop@1
# ```

# Once after login to MySQL prompt then run this SQL Command. This will uninstall the password validation feature like number of characters, password length, complexty and all. As I don’t want that I’d be uninstalling the `validate_password` plugin

# ## **Setup Needed for Application.**

# As per the architecture diagram, MySQL is needed by

# - Shipping Service

# So we need to load that schema into the database, So those applications will detect them and run accordingly.

# To download schema, Use the following command

# ```bash
# # curl -s -L -o /tmp/mysql.zip "https://github.com/stans-robot-project/mysql/archive/main.zip"
# ```

# Load the schema for mysql. This file contains the list of COUNTRIES, CITIES and their PINCODES. This will be helpful in doing the shipping charges calculation which is based on the distance the product is shippied 